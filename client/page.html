<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Meet&amp;Talk</title>
	<link rel="shortcut icon" href="favicon.ico">

	<link rel="stylesheet" href="styles/themes/meetandchat.min.css" />
	<link rel="stylesheet" href="styles/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile.structure-1.4.3.min.css" />

	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
	<script src="javascript/lib/moment.js"></script>
	<script src="javascript/lib/main.js"></script>


	<script type="text/javascript">

	var userdata;
	var facebookId;

	var getFacebookStatus = function(callback){
		setTimeout(function(){
			mainApp.getStatus(function(response){
				if(response.status === 'connected'){
					mainApp.getUserData(function(response){
						console.log("It was already logged in, got user data=", response);
						facebookId = response.id;
						callback && callback(response);
						
					});
				}
			});
		}, 250);
	};

	var fbLogin = function(){
		mainApp.login(function(response){
			mainApp.getUserData(function(response){
				console.log("got user data=", response);
				facebookId = response.id;
				createUser(response, function(){
					$.mobile.navigate("#profile");	
				});				
			});
		});
	};

	var createUser = function(data, callback){
		var url = "http://212.142.46.137/doh/profiles";
		var body = JSON.stringify({
		    "profile": {
		        "fb_user_id": data.id,
		        "name": data.first_name + " " + data.last_name,
		        "gender": data.gender,
		        "age": "100",
		        "country": "USA",
		        "hometown": "Seattle",
		        "picture_url": "http://upload.wikimedia.org/wikipedia/commons/0/09/Man_Silhouette.png"
		    }
		});
		console.log("createUser", url, body);
		$.ajax({
			url:url,
			type:"POST",
			data:body,
			contentType:"application/json; charset=utf-8",
			dataType:"json",
			success: function(json){
				console.log(json);
				callback && callback(json);
			}
		});

	};

	var getUserByFacebookId = function(facebook_id, callback) {
		console.log("getUserByFacebookId");
		if(!facebook_id){
			$.mobile.navigate("#login");
		}
		$.getJSON("http://212.142.46.137/doh/profiles/facebook/"+facebook_id, function(jsondata) {
			console.log(jsondata);
			userdata = jsondata;
			callback && callback(jsondata);
		})
		.fail(function(){
			$.mobile.navigate("#login");
		});
	}

	var getFlightCodes = function(callback){
		console.log("getFlightCodes");
		$.getJSON("http://212.142.46.137/doh/flights", function(jsondata) {
			console.log(jsondata);
			callback && callback(jsondata);
		})
		.fail(function(){
			console.error("Could not retrieve flights!!!");
		});
	};

	var choseFlight = function(value){
		var url = "http://212.142.46.137/doh/profiles/" + userdata._id + "/flight";
		var body = JSON.stringify({"flightNumber": value});
		console.log("choseFlight", url, body);
		$.ajax({
			url:url,
			type:"POST",
			data:body,
			contentType:"application/json; charset=utf-8",
			dataType:"json",
			success: function(json){
				console.log(json);
				if(json.result === "OK"){
					$.mobile.navigate("#match");
				}
				if(json.result === "FLIGHT_NOT_FOUND"){
					console.error("Such flight, much not found");
				}
			}
		});
	};

	var getProfiles = function(callback){
		console.log("getProfiles");
		$.getJSON("http://212.142.46.137/doh/profiles", function(jsondata) {
			console.log(jsondata);
			callback && callback(jsondata);
		})
	};

	// $(document).on("pageshow", function( event ) {
	//  console.log("pageshow " +event.target.id);
	// });

	$(document).on( "pageshow", function( event ) {
		console.log("pageshow: "+event.target.id);
		switch(event.target.id){
			case "login":
				getFacebookStatus(function(){
					$.mobile.navigate("#profile");
				})
				break;
			case "profile":
				getUserByFacebookId(facebookId, function(user){
					$("#profile-image").attr("src",user.profile.picture_url);
					$("#welcome-message").text("Welcome "+user.profile.name+"!");
				});
				break;
			case "flight":              
				getFlightCodes(function(jsondata){
					$("#flightlist").empty();
					jsondata.forEach(function(val){
						$("#flightlist").append('<li><a onclick="choseFlight.call(this,\''+val+'\')" href="javascript:void(0)">'+val+'</a></li>');
					});
					$('#flightlist').listview('refresh');
				});
				break;
			case "match":               
				getUserByFacebookId(facebookId);
				getProfiles(function(profiles){
					$("#matchlist").empty();
					profiles.forEach(function(val){
						var desttext = val.airport ? ('<p>Going to '+val.airport.city+' '+val.airport.country+'</p>') : '';
						var list = '<li><a href="#"><img class="match-image" src="'+val.profile.picture_url+'"><h2>'+val.profile.name+'</h2>'+desttext+'</a></li>';
						$("#matchlist").append(list);
					});
					$("#matchlist").listview('refresh');
				});
				break;
		}
	});


	</script>

	<style>
	#splash {
		background-color: #ef5ba1;
		text-align: center;
	}
	#login {
		background-color: #ef5ba1;
		text-align: center;
	}
	#profile{
		text-align: center;
	}
	.logo {
		width: 100%;
	}
	[data-role=footer] {
		opacity: 0.5;
		height: 15px;
		font-size: 0.75em;
		line-height: 15px;
		text-align: right;
	}
	.profile-image {
		width: 100px;
	}
	.match-image{
		width: 70px;
		height: 70px;
		margin: 5px;
	}
	</style>

</head>

<body>
	<div data-role="page" id="login">
		<div role="main" class="ui-content">
			<img class="logo" src="images/logo_pink.png">
			</br>
			</br>
			</br>
			<div id="login-button">
				<a onclick="fbLogin()">
					<img src="images/facebook_login.png">
				</a>
			</div>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="profile">
		<div role="main" class="ui-content">
			<img id="profile-image" src="" class="profile-image" />
			<h2 id="welcome-message"></h2>
			<p>Welcome to Meet & Chat</p>
			<p>To get in contact with people you bla bla bla... dave write something here please.</p>
			<a href="#flight" class="ui-btn">Set your destination</a>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="flight">
		<div role="main" class="ui-content">
			<div data-role="header">
				<h1>Your destination</h1>
			</div>
			<ul id="flightlist" data-role="listview" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Search your flight number..." data-inset="true"></ul>

		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="match">
		<div role="main" class="ui-content">
			<div data-role="header">
				<h1>Match here</h1>
			</div>
			<ul id="matchlist" data-role="listview" data-inset="true"></ul>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

</body>


</html>
