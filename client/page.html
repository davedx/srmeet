<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Meet&Talk</title>
	<link rel="shortcut icon" href="favicon.ico">

	<link rel="stylesheet" href="styles/themes/meetandchat.min.css" />
	<link rel="stylesheet" href="styles/themes/jquery.mobile.icons.min.css" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.3/jquery.mobile.structure-1.4.3.min.css" />

	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>
	<script src="javascript/lib/moment.js"></script>
    <script src="javascript/lib/main.js"></script>


	<script type="text/javascript">

		var apiBaseURL = "http://212.142.46.137/doh";

    setTimeout(function(){

        mainApp.getStatus(function(response){
            if(response.status === 'connected'){
                mainApp.getUserData(function(response){
                        console.log("It was already logged in, got user data=", response);
                        $.mobile.navigate("#profile");
                    });
            }else{
                $.mobile.navigate("#login");
                // mainApp.login(function(response){
                //     mainApp.getUserData(function(response){
                //         console.log("got user data=", response);
                //     });
                // });
            }

        });
        
    }, 500);


    function fbLogin(){
        mainApp.login(function(response){
                    mainApp.getUserData(function(response){
                        console.log("got user data=", response);
                        $.mobile.navigate("#profile");
                    });
                });
    }
    

	var userdata;
	var facebookId = "1j123y8hu2i34ui";

	var getUserByFacebookId = function(facebook_id, callback) {
		console.log("getUserByFacebookId");
		$.getJSON(apiBaseURL + "/profiles/facebook/"+facebook_id, function(jsondata) {
			console.log(jsondata);
			userdata = jsondata;
			callback && callback(jsondata);
		})
		.fail(function(){
			$.mobile.navigate("#login");
		});
	}

	var getFlightCodes = function(callback){
		console.log("getFlightCodes");
		$.getJSON(apiBaseURL + "/flights", function(jsondata) {
			console.log(jsondata);
			callback && callback(jsondata);
		})
		.fail(function(){
			console.error("Could not retrieve flights!!!");
		});
	};

	var getTimeFromFlight = function(flight) {
		if(!flight)
			return false;
		if(flight.time && flight.date) {
			var clean_date = (flight.date.split("+"))[0];
			var date_time_string = clean_date + "T" + flight.time;
			var date_time = moment(date_time_string);

			//HACK: for Hackathon we don't want to deal with rolling over to
			//tomorrow's flights and detecting when people have flown. Let's
			//pretend everyone with a valid flight is always on the next one
			//with that flight number.
			if(!date_time.isAfter()) {
				date_time.add(1, 'd');
			}

			return date_time;
		}
		return false;
	};

	var choseFlight = function(value){
		var url = apiBaseURL + "/profiles/" + userdata._id + "/flight";
		var body = JSON.stringify({"flightNumber": value});
		console.log("choseFlight", url, body);
		$.ajax({
			url:url,
			type:"POST",
			data:body,
			contentType:"application/json; charset=utf-8",
			dataType:"json",
			success: function(json){
				console.log(json);
				if(json.result === "OK"){
					$.mobile.navigate("#match");
				}
				if(json.result === "FLIGHT_NOT_FOUND"){
					console.error("Such flight, much not found");
				}
			}
		});
	};

	var getProfiles = function(callback){
		console.log("getProfiles");
		$.getJSON(apiBaseURL + "/profiles", function(jsondata) {
			console.log(jsondata);
			callback && callback(jsondata);
		})
	};

	var getMatches = function(){

	};

	$(document).on( "pagecreate", function( event ) {
		console.log("pagecreate: "+event.target.id);
		switch(event.target.id){
			case "splash":
				break;
			case "login":
				break;
			case "profile":
				getUserByFacebookId(facebookId, function(user){
					$("#profile-image").attr("src",user.profile.picture_url);
					$("#welcome-message").text("Welcome "+user.profile.name+"!");
				});
				break;
			case "flight":				
				getFlightCodes(function(jsondata){
					$("#flightlist").empty();
					jsondata.forEach(function(val){
						$("#flightlist").append('<li><a onclick="choseFlight.call(this,\''+val+'\')" href="javascript:void(0)">'+val+'</a></li>');
					});
					$('#flightlist').listview('refresh');
				});
				break;
			case "match":				
				getUserByFacebookId(facebookId);
				getProfiles(function(profiles){
					$("#matchlist").empty();
					profiles.forEach(function(val){
						var flightTime = getTimeFromFlight(val.flight);
						if(flightTime && flightTime.isAfter()) {
							var formatted = flightTime.fromNow();
							var desttext = val.airport ? ('<p>Going to '+val.airport.city+' '+formatted+'</p>') : '';
							var list = '<li><a href="#"><img src="'+val.profile.picture_url+'"><h2>'+val.profile.name+'</h2>'+desttext+'</a></li>';
							$("#matchlist").append(list);
						}
					});
					$("#matchlist").listview('refresh');
				});
				break;
		}
	});


	</script>

	<style>
	#splash {
		background-color: #ef5ba1;
		text-align: center;
	}
	#login {
		background-color: #ef5ba1;
		text-align: center;
	}
	#profile{
		text-align: center;
	}
	.logo {
		width: 100%;
	}
	[data-role=footer] {
		opacity: 0.5;
		height: 15px;
		font-size: 0.75em;
		line-height: 15px;
		text-align: right;
	}
	.profile-image {
		width: 100px;
	}
	</style>

</head>

<body>
	<div data-role="page" id="splash">
		<div role="main" class="ui-content">
			<img class="logo" src="images/logo_pink.png">
			</br>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="login">
		<div role="main" class="ui-content">
			<img class="logo" src="images/logo_pink.png">
			</br>
			<a onclick="fbLogin()">
				<img src="images/facebook_login.png">
			</a>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="profile">
		<div role="main" class="ui-content">
			<img id="profile-image" src="" class="profile-image" />
			<h2 id="welcome-message"></h2>
			<p>Welcome to Meet & Chat</p>
			<p>To get in contact with people you bla bla bla... dave write something here please.</p>
			<a href="#flight" class="ui-btn">Set your destination</a>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="flight">
		<div role="main" class="ui-content">
			<div data-role="header">
				<h1>Your destination</h1>
			</div>
			
			<ul id="flightlist" data-role="listview" data-filter="true" data-filter-reveal="true" data-filter-placeholder="Search your flight number..." data-inset="true">
			</ul>

		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

	<div data-role="page" id="match">
		<div role="main" class="ui-content">
			<div data-role="header">
				<h1>Match here</h1>
			</div>
			<ul id="matchlist" data-role="listview" data-inset="true">
			    
			</ul>
		</div>
		<div data-role="footer" data-position="fixed">
			&copy; Schiphol 2014
		</div>
	</div>

</body>


</html>
